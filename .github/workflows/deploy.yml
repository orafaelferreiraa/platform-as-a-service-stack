name: Deploy Platform Infrastructure

on:
  workflow_dispatch:
    inputs:
      name:
        description: 'Name (team or product - lowercase alphanumeric)'
        required: true
        type: string
      action:
        description: 'Terraform action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
        default: plan
      
      # Feature Flags - Control which resources to deploy
      enable_managed_identity:
        description: 'Enable Managed Identity (required by: Storage, Service Bus, Event Grid, SQL, Key Vault)'
        required: false
        type: boolean
        default: true
      enable_vnet:
        description: 'Enable Virtual Network'
        required: false
        type: boolean
        default: true
      enable_observability:
        description: 'Enable Observability (Log Analytics + App Insights)'
        required: false
        type: boolean
        default: true
      enable_key_vault:
        description: 'Enable Key Vault'
        required: false
        type: boolean
        default: true
      enable_storage:
        description: 'Enable Storage Account'
        required: false
        type: boolean
        default: true
      enable_service_bus:
        description: 'Enable Service Bus'
        required: false
        type: boolean
        default: true
      enable_event_grid:
        description: 'Enable Event Grid'
        required: false
        type: boolean
        default: true
      enable_sql:
        description: 'Enable SQL Server & Database'
        required: false
        type: boolean
        default: true
      enable_container_apps:
        description: 'Enable Container Apps (requires Observability)'
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  id-token: write

jobs:
  terraform:
    runs-on: ubuntu-latest
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      TF_VAR_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      TF_VAR_name: ${{ inputs.name }}
      # Feature flags as environment variables
      TF_VAR_enable_managed_identity: ${{ inputs.enable_managed_identity }}
      TF_VAR_enable_vnet: ${{ inputs.enable_vnet }}
      TF_VAR_enable_observability: ${{ inputs.enable_observability }}
      TF_VAR_enable_key_vault: ${{ inputs.enable_key_vault }}
      TF_VAR_enable_storage: ${{ inputs.enable_storage }}
      TF_VAR_enable_service_bus: ${{ inputs.enable_service_bus }}
      TF_VAR_enable_event_grid: ${{ inputs.enable_event_grid }}
      TF_VAR_enable_sql: ${{ inputs.enable_sql }}
      TF_VAR_enable_container_apps: ${{ inputs.enable_container_apps }}
    
    defaults:
      run:
        shell: bash
        working-directory: terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display Configuration
        run: |
          echo "## Platform Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform Name:** \`${{ inputs.name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** \`${{ inputs.action }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources to Deploy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Enabled |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | ✅ Always |" >> $GITHUB_STEP_SUMMARY
          echo "| Managed Identity | ${{ inputs.enable_managed_identity == true && '✅ Yes' || '❌ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Virtual Network | ${{ inputs.enable_vnet == true && '✅ Yes' || '❌ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Observability | ${{ inputs.enable_observability == true && '✅ Yes' || '❌ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Key Vault | ${{ inputs.enable_key_vault == true && '✅ Yes' || '❌ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Storage Account | ${{ inputs.enable_storage == true && '✅ Yes' || '❌ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Service Bus | ${{ inputs.enable_service_bus == true && '✅ Yes' || '❌ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Event Grid | ${{ inputs.enable_event_grid == true && '✅ Yes' || '❌ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SQL Server & Database | ${{ inputs.enable_sql == true && '✅ Yes' || '❌ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Apps | ${{ inputs.enable_container_apps == true && '✅ Yes' || '❌ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Validation warnings
          if [ "${{ inputs.enable_container_apps }}" == "true" ] && [ "${{ inputs.enable_observability }}" != "true" ]; then
            echo "### ⚠️ Validation Warning" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Container Apps requires Observability to be enabled. The deployment will fail." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Managed Identity dependency warnings
          if [ "${{ inputs.enable_managed_identity }}" != "true" ]; then
            NEEDS_IDENTITY=false
            RESOURCES_NEEDING=""
            if [ "${{ inputs.enable_storage }}" == "true" ]; then NEEDS_IDENTITY=true; RESOURCES_NEEDING="Storage Account"; fi
            if [ "${{ inputs.enable_service_bus }}" == "true" ]; then NEEDS_IDENTITY=true; RESOURCES_NEEDING="$RESOURCES_NEEDING, Service Bus"; fi
            if [ "${{ inputs.enable_event_grid }}" == "true" ]; then NEEDS_IDENTITY=true; RESOURCES_NEEDING="$RESOURCES_NEEDING, Event Grid"; fi
            if [ "${{ inputs.enable_sql }}" == "true" ]; then NEEDS_IDENTITY=true; RESOURCES_NEEDING="$RESOURCES_NEEDING, SQL"; fi
            if [ "${{ inputs.enable_key_vault }}" == "true" ]; then NEEDS_IDENTITY=true; RESOURCES_NEEDING="$RESOURCES_NEEDING, Key Vault"; fi
            if [ "$NEEDS_IDENTITY" == "true" ]; then
              echo "### ⚠️ Managed Identity Warning" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "The following resources require Managed Identity for RBAC: $RESOURCES_NEEDING" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.9.0"

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        run: |
          terraform init -input=false \
            -backend-config="resource_group_name=rg-paas" \
            -backend-config="storage_account_name=storagepaas" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=${{ env.TF_VAR_name }}.terraform.tfstate" \
            -backend-config="use_azuread_auth=true"

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        if: inputs.action == 'plan' || inputs.action == 'apply'
        run: terraform plan -input=false -lock=false -out=tfplan -refresh=false

      - name: Terraform Apply
        if: inputs.action == 'apply'
        run: terraform apply -input=false -lock=false -auto-approve tfplan

      - name: Terraform Destroy
        if: inputs.action == 'destroy'
        run: terraform destroy -input=false -lock=false -auto-approve

      - name: Upload Plan Artifact
        if: inputs.action == 'plan'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ inputs.name }}
          path: terraform/tfplan
          retention-days: 7
