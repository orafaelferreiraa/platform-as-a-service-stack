name: Deploy Platform Infrastructure

on:
  workflow_dispatch:
    inputs:
      name:
        description: 'Name (team or product - lowercase alphanumeric)'
        required: true
        type: string
      action:
        description: 'Terraform action to perform'
        required: true
        type: choice
        options:
          - plan
          - apply
        default: plan
      
      # Feature Flags - Control which resources to deploy
      enable_managed_identity:
        description: 'Enable Managed Identity (required by: Storage, Service Bus, Event Grid, SQL, Key Vault)'
        required: false
        type: boolean
        default: true
      enable_vnet:
        description: 'Enable Virtual Network'
        required: false
        type: boolean
        default: true
      enable_observability:
        description: 'Enable Observability (Log Analytics + App Insights)'
        required: false
        type: boolean
        default: true
      enable_key_vault:
        description: 'Enable Key Vault'
        required: false
        type: boolean
        default: true
      enable_storage:
        description: 'Enable Storage Account'
        required: false
        type: boolean
        default: true
      enable_service_bus:
        description: 'Enable Service Bus'
        required: false
        type: boolean
        default: true
      enable_event_grid:
        description: 'Enable Event Grid'
        required: false
        type: boolean
        default: true
      enable_sql:
        description: 'Enable SQL Server & Database'
        required: false
        type: boolean
        default: true
      enable_container_apps:
        description: 'Enable Container Apps (requires Observability)'
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  id-token: write

jobs:
  terraform:
    runs-on: ubuntu-latest
    env:
      ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      TF_VAR_subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      TF_VAR_name: ${{ inputs.name }}
      # Feature flags as environment variables
      TF_VAR_enable_managed_identity: ${{ inputs.enable_managed_identity }}
      TF_VAR_enable_vnet: ${{ inputs.enable_vnet }}
      TF_VAR_enable_observability: ${{ inputs.enable_observability }}
      TF_VAR_enable_key_vault: ${{ inputs.enable_key_vault }}
      TF_VAR_enable_storage: ${{ inputs.enable_storage }}
      TF_VAR_enable_service_bus: ${{ inputs.enable_service_bus }}
      TF_VAR_enable_event_grid: ${{ inputs.enable_event_grid }}
      TF_VAR_enable_sql: ${{ inputs.enable_sql }}
      TF_VAR_enable_container_apps: ${{ inputs.enable_container_apps }}
    
    defaults:
      run:
        shell: bash
        working-directory: terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: Display Configuration
        run: |
          echo "## Platform Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform Name:** \`${{ inputs.name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** \`${{ inputs.action }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources to Deploy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Enabled |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | ✅ Always |" >> $GITHUB_STEP_SUMMARY
          echo "| Managed Identity | ${{ inputs.enable_managed_identity == true && '✅ Yes' || '❌ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Virtual Network | ${{ inputs.enable_vnet == true && '✅ Yes' || '❌ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Observability | ${{ inputs.enable_observability == true && '✅ Yes' || '❌ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Key Vault | ${{ inputs.enable_key_vault == true && '✅ Yes' || '❌ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Storage Account | ${{ inputs.enable_storage == true && '✅ Yes' || '❌ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Service Bus | ${{ inputs.enable_service_bus == true && '✅ Yes' || '❌ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Event Grid | ${{ inputs.enable_event_grid == true && '✅ Yes' || '❌ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SQL Server & Database | ${{ inputs.enable_sql == true && '✅ Yes' || '❌ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Apps | ${{ inputs.enable_container_apps == true && '✅ Yes' || '❌ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Validation warnings
          if [ "${{ inputs.enable_container_apps }}" == "true" ] && [ "${{ inputs.enable_observability }}" != "true" ]; then
            echo "### ⚠️ Validation Warning" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Container Apps requires Observability to be enabled. The deployment will fail." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Managed Identity dependency warnings
          if [ "${{ inputs.enable_managed_identity }}" != "true" ]; then
            NEEDS_IDENTITY=false
            RESOURCES_NEEDING=""
            if [ "${{ inputs.enable_storage }}" == "true" ]; then NEEDS_IDENTITY=true; RESOURCES_NEEDING="Storage Account"; fi
            if [ "${{ inputs.enable_service_bus }}" == "true" ]; then NEEDS_IDENTITY=true; RESOURCES_NEEDING="$RESOURCES_NEEDING, Service Bus"; fi
            if [ "${{ inputs.enable_event_grid }}" == "true" ]; then NEEDS_IDENTITY=true; RESOURCES_NEEDING="$RESOURCES_NEEDING, Event Grid"; fi
            if [ "${{ inputs.enable_sql }}" == "true" ]; then NEEDS_IDENTITY=true; RESOURCES_NEEDING="$RESOURCES_NEEDING, SQL"; fi
            if [ "${{ inputs.enable_key_vault }}" == "true" ]; then NEEDS_IDENTITY=true; RESOURCES_NEEDING="$RESOURCES_NEEDING, Key Vault"; fi
            if [ "$NEEDS_IDENTITY" == "true" ]; then
              echo "### ⚠️ Managed Identity Warning" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "The following resources require Managed Identity for RBAC: $RESOURCES_NEEDING" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.9.0"

      - name: Terraform Format Check
        run: terraform fmt -recursive
        continue-on-error: true

      - name: Terraform Init
        run: |
          terraform init -input=false \
            -backend-config="resource_group_name=rg-paas" \
            -backend-config="storage_account_name=storagepaas" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=${{ env.TF_VAR_name }}.terraform.tfstate" \
            -backend-config="use_azuread_auth=true"

      - name: Terraform Validate
        run: terraform validate

      - name: Break State Lease (if exists)
        run: |
          az storage blob lease break \
            --blob-name "${{ env.TF_VAR_name }}.terraform.tfstate" \
            --container-name "tfstate" \
            --account-name "storagepaas" \
            --auth-mode login || true

      - name: Build Terraform Targets
        run: |
          # Start with core resources that are always deployed
          TARGETS="-target=module.naming -target=module.resource_group"
          
          # Check state for existing resources and preserve them in targets
          # This prevents terraform from trying to destroy existing resources when we add new ones
          echo "Checking state for existing resources..."
          STATE_RESOURCES=$(terraform state list 2>/dev/null || echo "")
          
          # Check what resources exist in state
          HAS_MANAGED_IDENTITY=$(echo "$STATE_RESOURCES" | grep -c "module.managed_identity" || echo "0")
          HAS_VNET=$(echo "$STATE_RESOURCES" | grep -c "module.vnet_spoke" || echo "0")
          HAS_OBSERVABILITY=$(echo "$STATE_RESOURCES" | grep -c "module.observability" || echo "0")
          HAS_STORAGE=$(echo "$STATE_RESOURCES" | grep -c "module.storage_account" || echo "0")
          HAS_SERVICE_BUS=$(echo "$STATE_RESOURCES" | grep -c "module.service_bus" || echo "0")
          HAS_EVENT_GRID=$(echo "$STATE_RESOURCES" | grep -c "module.event_grid" || echo "0")
          HAS_SQL=$(echo "$STATE_RESOURCES" | grep -c "module.sql" || echo "0")
          HAS_KEY_VAULT=$(echo "$STATE_RESOURCES" | grep -c "module.key_vault" || echo "0")
          HAS_CONTAINER_APPS=$(echo "$STATE_RESOURCES" | grep -c "module.container_apps" || echo "0")
          
          # Include resources that are EITHER enabled OR already exist in state
          # This prevents destruction of existing resources
          if [ "${{ inputs.enable_managed_identity }}" == "true" ] || [ "$HAS_MANAGED_IDENTITY" -gt "0" ]; then 
            TARGETS="$TARGETS -target=module.managed_identity"
            echo "Including Managed Identity (enabled: ${{ inputs.enable_managed_identity }}, in state: $HAS_MANAGED_IDENTITY)"
          fi
          
          if [ "${{ inputs.enable_vnet }}" == "true" ] || [ "$HAS_VNET" -gt "0" ]; then 
            TARGETS="$TARGETS -target=module.vnet_spoke"
            echo "Including VNet (enabled: ${{ inputs.enable_vnet }}, in state: $HAS_VNET)"
          fi
          
          if [ "${{ inputs.enable_observability }}" == "true" ] || [ "$HAS_OBSERVABILITY" -gt "0" ]; then 
            TARGETS="$TARGETS -target=module.observability"
            echo "Including Observability (enabled: ${{ inputs.enable_observability }}, in state: $HAS_OBSERVABILITY)"
          fi
          
          if [ "${{ inputs.enable_storage }}" == "true" ] || [ "$HAS_STORAGE" -gt "0" ]; then 
            TARGETS="$TARGETS -target=module.storage_account"
            echo "Including Storage (enabled: ${{ inputs.enable_storage }}, in state: $HAS_STORAGE)"
          fi
          
          if [ "${{ inputs.enable_service_bus }}" == "true" ] || [ "$HAS_SERVICE_BUS" -gt "0" ]; then 
            TARGETS="$TARGETS -target=module.service_bus"
            echo "Including Service Bus (enabled: ${{ inputs.enable_service_bus }}, in state: $HAS_SERVICE_BUS)"
          fi
          
          if [ "${{ inputs.enable_event_grid }}" == "true" ] || [ "$HAS_EVENT_GRID" -gt "0" ]; then 
            TARGETS="$TARGETS -target=module.event_grid"
            echo "Including Event Grid (enabled: ${{ inputs.enable_event_grid }}, in state: $HAS_EVENT_GRID)"
          fi
          
          if [ "${{ inputs.enable_sql }}" == "true" ] || [ "$HAS_SQL" -gt "0" ]; then 
            TARGETS="$TARGETS -target=module.sql"
            echo "Including SQL (enabled: ${{ inputs.enable_sql }}, in state: $HAS_SQL)"
          fi
          
          if [ "${{ inputs.enable_key_vault }}" == "true" ] || [ "$HAS_KEY_VAULT" -gt "0" ]; then 
            TARGETS="$TARGETS -target=module.key_vault"
            echo "Including Key Vault (enabled: ${{ inputs.enable_key_vault }}, in state: $HAS_KEY_VAULT)"
          fi
          
          if [ "${{ inputs.enable_container_apps }}" == "true" ] || [ "$HAS_CONTAINER_APPS" -gt "0" ]; then 
            TARGETS="$TARGETS -target=module.container_apps"
            echo "Including Container Apps (enabled: ${{ inputs.enable_container_apps }}, in state: $HAS_CONTAINER_APPS)"
          fi
          
          # Root-level RBAC when all three are enabled: SQL + KV + Managed Identity
          if [ "${{ inputs.enable_sql }}" == "true" ] && [ "${{ inputs.enable_key_vault }}" == "true" ] && [ "${{ inputs.enable_managed_identity }}" == "true" ]; then
            TARGETS="$TARGETS -target=azurerm_role_assignment.sql_key_vault_access"
          fi
          
          echo "TF_TARGETS=$TARGETS" >> $GITHUB_ENV
          echo ""
          echo "Final Terraform targets: $TARGETS"

      - name: Terraform Plan
        if: inputs.action == 'plan' || inputs.action == 'apply'
        run: terraform plan -input=false -lock=false -out=tfplan $TF_TARGETS

      - name: Terraform Apply
        if: inputs.action == 'apply'
        run: terraform apply -input=false -lock=false -auto-approve tfplan

      - name: Upload Plan Artifact
        if: inputs.action == 'plan'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ inputs.name }}
          path: terraform/tfplan
          retention-days: 7
